<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Manuel - Probl√®me Entr√©e avant ==Surlign√©==</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            line-height: 1.6;
        }
        .test-container {
            border: 2px solid #444;
            padding: 20px;
            margin: 20px 0;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .editor-line {
            border: 1px solid #666;
            padding: 10px;
            margin: 10px 0;
            background: #333;
            cursor: text;
            border-radius: 4px;
            min-height: 24px;
        }
        .current-line {
            border-color: #0066cc;
            background: #003366;
        }
        .instructions {
            background: #004400;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .problem-description {
            background: #660000;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .solution {
            background: #006600;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #0088ff;
        }
        .log {
            background: #222;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #0066cc;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass { background: #004400; }
        .fail { background: #440000; }
        .pending { background: #444400; }
    </style>
</head>
<body>
    <h1>üß™ Test Manuel: Probl√®me Entr√©e avant ==Surlign√©==</h1>
    
    <div class="problem-description">
        <h2>üìã Description du Probl√®me</h2>
        <p><strong>Sc√©nario:</strong> Lorsque le curseur est plac√© avant "==Surlign√©==" et qu'on appuie sur Entr√©e pour mettre le contenu suivant sur une nouvelle ligne:</p>
        <ol>
            <li>Le rendu HTML se d√©clenche avant que le syst√®me ne r√©alise que le curseur va changer de ligne</li>
            <li>Apr√®s que le syst√®me se rende compte du changement, le rendu dispara√Æt</li>
            <li>Le curseur appara√Æt incorrectement apr√®s les marqueurs "=="</li>
        </ol>
        <p><strong>Contenu test:</strong> "- *Italique* ==Surlign√©== fin"</p>
        <p><strong>Position probl√©matique:</strong> Juste avant "==Surlign√©=="</p>
    </div>
    
    <div class="instructions">
        <h2>üìù Instructions de Test</h2>
        <ol>
            <li>Cliquez dans la ligne de test ci-dessous</li>
            <li>Placez votre curseur juste avant "==Surlign√©=="</li>
            <li>Appuyez sur Entr√©e</li>
            <li>Observez le comportement du curseur et du rendu</li>
        </ol>
        <p><strong>R√©sultat attendu:</strong> Le contenu doit se diviser proprement avec "- *Italique* " sur la premi√®re ligne et "==Surlign√©== fin" sur la nouvelle ligne, sans conflit de rendu.</p>
    </div>
    
    <div class="test-container">
        <h3>Test Case: Division de ligne avec formatage</h3>
        <div id="testLine" class="editor-line current-line" contenteditable="true">- <em>Italique</em> <mark>Surlign√©</mark> fin</div>
        <div class="test-status pending" id="testStatus">En attente de test...</div>
        <button onclick="setupTest()">üîÑ R√©initialiser Test</button>
        <button onclick="runAutomatedTest()">ü§ñ Test Automatique</button>
        <button onclick="showCursorInfo()">üìç Info Curseur</button>
    </div>
    
    <div class="solution">
        <h2>üõ†Ô∏è Solution Impl√©ment√©e</h2>
        <p><strong>CursorManager avec verrouillage d'op√©rations:</strong></p>
        <ul>
            <li>Verrouillage des transitions pendant les op√©rations critiques</li>
            <li>D√©tection intelligente des marqueurs de formatage</li>
            <li>Ajustement automatique de la position du curseur</li>
            <li>Gestion des op√©rations asynchrones</li>
        </ul>
    </div>
    
    <div class="log" id="logOutput">
        <strong>üìä Journal de test:</strong><br>
        Pr√™t pour les tests...
    </div>
    
    <script>
        let testLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMsg = `[${timestamp}] ${message}`;
            testLog.push(logMsg);
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = '<strong>üìä Journal de test:</strong><br>' + testLog.slice(-20).join('<br>');
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(logMsg);
        }
        
        function setupTest() {
            log('üîÑ R√©initialisation du test...');
            const testLine = document.getElementById('testLine');
            testLine.innerHTML = '- <em>Italique</em> <mark>Surlign√©</mark> fin';
            testLine.focus();
            document.getElementById('testStatus').textContent = 'Test r√©initialis√© - Placez le curseur avant "==Surlign√©==" et appuyez sur Entr√©e';
            document.getElementById('testStatus').className = 'test-status pending';
        }
        
        function showCursorInfo() {
            const testLine = document.getElementById('testLine');
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const preCaretRange = range.cloneRange();
                preCaretRange.selectNodeContents(testLine);
                preCaretRange.setEnd(range.startContainer, range.startOffset);
                const position = preCaretRange.toString().length;
                const textContent = testLine.textContent;
                const charAtPosition = textContent[position] || '(fin)';
                
                log(`üìç Position curseur: ${position}, Caract√®re: "${charAtPosition}"`);
                log(`üìÑ Contenu HTML: "${testLine.textContent}"`);
                log(`üìù Contenu markdown simul√©: "- *Italique* ==Surlign√©== fin"`);
            } else {
                log('‚ö†Ô∏è Aucune s√©lection trouv√©e');
            }
        }
        
        function runAutomatedTest() {
            log('ü§ñ D√©marrage du test automatique...');
            
            const markdownContent = '- *Italique* ==Surlign√©== fin';
            const htmlContent = '- Italique Surlign√© fin';
            const problemPosition = 13; // Position juste avant "=="
            
            log(`üìã Test: Division de ligne √† la position ${problemPosition}`);
            log(`   Markdown: "${markdownContent}"`);
            log(`   HTML: "${htmlContent}"`);
            
            // Simule la logique de division
            const beforeCursor = markdownContent.substring(0, problemPosition);
            const afterCursor = markdownContent.substring(problemPosition);
            
            log(`‚úÇÔ∏è Division simul√©e:`);
            log(`   Avant curseur: "${beforeCursor}"`);
            log(`   Apr√®s curseur: "${afterCursor}"`);
            
            const expectedBefore = '- *Italique* ';
            const expectedAfter = '==Surlign√©== fin';
            
            const beforeCorrect = beforeCursor === expectedBefore;
            const afterCorrect = afterCursor === expectedAfter;
            
            if (beforeCorrect && afterCorrect) {
                log('‚úÖ Test automatique R√âUSSI');
                document.getElementById('testStatus').textContent = 'Test automatique r√©ussi - La logique de division fonctionne correctement';
                document.getElementById('testStatus').className = 'test-status pass';
            } else {
                log('‚ùå Test automatique √âCHOU√â');
                log(`   Attendu avant: "${expectedBefore}"`);
                log(`   Attendu apr√®s: "${expectedAfter}"`);
                document.getElementById('testStatus').textContent = 'Test automatique √©chou√© - V√©rifiez la logique de division';
                document.getElementById('testStatus').className = 'test-status fail';
            }
        }
        
        // D√©tection automatique de l'appui sur Entr√©e
        document.getElementById('testLine').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                log('‚ö° Touche Entr√©e d√©tect√©e!');
                showCursorInfo();
                log('‚ö†Ô∏è Note: Dans l\'√©diteur principal, le CursorManager g√©rerait cette op√©ration avec verrouillage');
            }
        });
        
        // Initialisation
        log('üöÄ Test manuel pr√™t');
        log('üí° Astuce: Utilisez les boutons pour tester ou observez le comportement manuel');
    </script>
</body>
</html>